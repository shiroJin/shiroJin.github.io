<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">
<meta name="referrer" content="no-referrer">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一个c语言编写的文件，需要经过以下四个步骤最后才能成为一个可执行文件。  预处理 编译 汇编 链接  ​	可以简单的理解为1-3步骤是对代码语言的处理，将高级语言译成机器可以识别的机器语言。步骤4是将每个编译后的文件整合为一个完整的可执行文件，链接的实质是将符号和定义联系在一起。 ELF结构: ​	下表为ELF文件主体结构，每个ELF文件都是由多个段组成的，一些复杂的elf文件会涵盖很多不同的段，">
<meta property="og:type" content="article">
<meta property="og:title" content="初识链接器">
<meta property="og:url" content="http://example.com/2019/08/19/%E5%88%9D%E8%AF%86%E9%93%BE%E6%8E%A5%E5%99%A8/index.html">
<meta property="og:site_name" content="一只代码狗的随笔">
<meta property="og:description" content="一个c语言编写的文件，需要经过以下四个步骤最后才能成为一个可执行文件。  预处理 编译 汇编 链接  ​	可以简单的理解为1-3步骤是对代码语言的处理，将高级语言译成机器可以识别的机器语言。步骤4是将每个编译后的文件整合为一个完整的可执行文件，链接的实质是将符号和定义联系在一起。 ELF结构: ​	下表为ELF文件主体结构，每个ELF文件都是由多个段组成的，一些复杂的elf文件会涵盖很多不同的段，">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/shiroJin/image-storage/master/linker_1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/shiroJin/image-storage/master/linker_2.png">
<meta property="article:published_time" content="2019-08-18T16:09:00.000Z">
<meta property="article:modified_time" content="2019-08-18T16:09:00.000Z">
<meta property="article:author" content="Jin.">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/shiroJin/image-storage/master/linker_1.png">


<link rel="canonical" href="http://example.com/2019/08/19/%E5%88%9D%E8%AF%86%E9%93%BE%E6%8E%A5%E5%99%A8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2019/08/19/%E5%88%9D%E8%AF%86%E9%93%BE%E6%8E%A5%E5%99%A8/","path":"2019/08/19/初识链接器/","title":"初识链接器"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>初识链接器 | 一只代码狗的随笔</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">一只代码狗的随笔</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">知其然知其所以然！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5%E5%99%A8"><span class="nav-number">1.</span> <span class="nav-text">静态链接器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%81%8C%E8%B4%A3"><span class="nav-number">1.0.1.</span> <span class="nav-text">职责</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">工作流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%99%A8"><span class="nav-number">2.</span> <span class="nav-text">动态链接器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number">2.1.</span> <span class="nav-text">参考文献</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jin.</p>
  <div class="site-description" itemprop="description">知其然知其所以然！</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/08/19/%E5%88%9D%E8%AF%86%E9%93%BE%E6%8E%A5%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jin.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只代码狗的随笔">
      <meta itemprop="description" content="知其然知其所以然！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="初识链接器 | 一只代码狗的随笔">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          初识链接器
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-08-19 00:09:00" itemprop="dateCreated datePublished" datetime="2019-08-19T00:09:00+08:00">2019-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>一个c语言编写的文件，需要经过以下四个步骤最后才能成为一个可执行文件。</p>
<ol>
<li>预处理</li>
<li>编译</li>
<li>汇编</li>
<li>链接</li>
</ol>
<p>​	可以简单的理解为1-3步骤是对代码语言的处理，将高级语言译成机器可以识别的机器语言。步骤4是将每个编译后的文件整合为一个完整的可执行文件，链接的实质是将符号和定义联系在一起。</p>
<p><strong>ELF结构:</strong></p>
<p>​	下表为ELF文件主体结构，每个ELF文件都是由多个段组成的，一些复杂的elf文件会涵盖很多不同的段，一些简单的ELF文件可能只包括少数的段。这些都是由代码中数据决定的。<span id="more"></span></p>
<table>
<thead>
<tr>
<th>Sections</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>.text</td>
<td>代码段</td>
</tr>
<tr>
<td>.data</td>
<td>未初始化和为0的全局变量&#x2F;静态变量。</td>
</tr>
<tr>
<td>.bss</td>
<td>未初始化的全局变量</td>
</tr>
<tr>
<td>.symtab</td>
<td>符号表</td>
</tr>
<tr>
<td>.rel.text</td>
<td>模块中引用或定义的全局函数的重定位信息</td>
</tr>
<tr>
<td>.rel.data</td>
<td>模块中引用或定义的全局变量的重定位信息</td>
</tr>
<tr>
<td>.strtab</td>
<td>字符串表</td>
</tr>
<tr>
<td>…</td>
<td>一些其他的段</td>
</tr>
</tbody></table>
<p>​	链接器的主要工作内容为两部分：</p>
<ul>
<li><p><strong>符号解析</strong></p>
<p>将符号的引用和符号的定义关联起来，生成一个完整的符号表。</p>
</li>
<li><p><strong>重定位</strong></p>
<p>单个文件中引用的符号内存地址是不正确的，需要在链接过程中进行纠正。</p>
</li>
</ul>
<h2 id="静态链接器"><a href="#静态链接器" class="headerlink" title="静态链接器"></a>静态链接器</h2><h4 id="职责"><a href="#职责" class="headerlink" title="职责"></a>职责</h4><ul>
<li><p>输入：编译后的ELF文件</p>
</li>
<li><p>输出：将多个文件中引符号重定位，不同文件中相同段的合并，最后合成一个可执行文件</p>
</li>
</ul>
<h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p><strong>一、段空间和地址分配</strong></p>
<p>​	扫描所有的输入目标文件，收集所有目标文件的符号表到一个全局符号表中，将相同的段合并。在所有段合并成一个完整的文件后，符号的地址也随之可以确定下来。</p>
<img src="https://raw.githubusercontent.com/shiroJin/image-storage/master/linker_1.png">

<p style="text-align:center;font-style:italic;">section合并</p>
>**段合并**：程序在装载的时候，段的装载地址和空间的对齐单位是页，对于x86设备来说，页的大小是4096字节，即4kb。对于一个仅仅一个字节的段，它占据的空间也是4kb，这就造成了极大的空间浪费。因此相同段需要合并。

<p><strong>二、符号解析</strong></p>
<p>​	每个编译文件中都有自己符号表，符号有些事静态的，有些是全局的。对于全局的，不同的文件定义的、引用的符号各不相同。全局变量的符号放在Common段中，静态变量放在bss段中，因为静态变量的大小是确定的，而全局变量因为弱类型进制的缘故，全局变量的符号大小时不确定的。对于静态的符号，段的地址确定后，静态符号的地址也就能确定。对于全局变量，不容的文件中可能定义了相同的符号，对于有冲突的符号需要进行符号决议，最终确定符号的地址。</p>
<blockquote>
<p><strong>符号决议：</strong><br>    确定符号的定义，符号的定义有强弱之分，强符号覆盖弱符号。若在不同段中定义了相同的强符号，链接就会失败。</p>
</blockquote>
<p><strong>三、符号重定位</strong></p>
<p>​	对于单个文件，引用了其他文件的符号，这个符号的地址是未确认的，只是一个占位符，但不是实际符号的地址。例如，一个文件中引用了foo函数，但是foo函数定义在其他文件中，当编译器编译这个文件时，编译器并不知道foo这个符号的地址。对于单个的ELF文件，foo函数这个符号是没有定义的。符号的重定位是链接器是主要工作内容。链接器将没有地址的符号赋予正确的地址。</p>
<p>​	符号重定位有两种方式，绝对寻址和相对寻址。</p>
<blockquote>
<p>A：保存在被修正位置的值</p>
<p>B：被修正的位置（相对于段开始的偏移量或者虚拟地址）</p>
<p>P：符号的实际地址</p>
<ul>
<li><p>绝对寻址 S+A</p>
</li>
<li><p>相对寻址 S+A-P</p>
</li>
</ul>
</blockquote>
<p><strong>四、输出文件</strong></p>
<p>​	待所有符号重定位结束后，得到一个.out文件，一个可执行文件，文件中只有.bss，.text，.data段。没有符号表之类的段。</p>
<h2 id="动态链接器"><a href="#动态链接器" class="headerlink" title="动态链接器"></a>动态链接器</h2><p>​	由于静态链接库在每个可执行文件中都有一份，导致了内存浪费的问题。如果可执行文件可以使用共享库就可以减少内存开支。动态链接库就是为了共享库而存在的，共享库的符号解析和重定位的工作由动态链接器完成。</p>
<img src="https://raw.githubusercontent.com/shiroJin/image-storage/master/linker_2.png">

<p style="text-align: center;font-style: italic">动态库内存分配</p>
​	动态链接库的代码在多个进程间是共享的，动态库只会加载到内存中一次。当随后的进程链接动态库时不需要再次加载进内存，从而到达了节省内存的目的。

<p>​	在静态链接阶段，根据动态库的符号表，动态库中的符号会被标记。在静态链接的时候不会对标记的符号进行重定位。重定位的过程留在了程序加载时。</p>
<blockquote>
<p><em>接下来思考一下两个问题：</em></p>
<ol>
<li>执行文件如何进行重定位</li>
<li>共享库数据是否会共享</li>
</ol>
</blockquote>
<p>​	<strong>动态库的装载地址在编译阶段无法确定，只有在装载时才能确定</strong>。因此动态库的符号重定位与静态库的重定位方式不同。另外，对于每个动态库，多个进程之间代码段是共享的，数据段每个进程都会有自己独立的副本。</p>
<p><strong>一、位置无关代码IPC</strong></p>
<ul>
<li><p>模块内函数调用及跳转</p>
<p>内部函数的相对位置不会改变，他们的相对的偏移量是确定的，因此内部函数调用通过相对寻址进行定位。</p>
</li>
<li><p>模块内数据访问</p>
<p>跟内部函数一样，模块内部的数据距整理个模块的起始地址的偏移量是固定的，只需要相对寻址就可以定位的对应的数据。</p>
</li>
<li><p>模块间函数调用及跳转</p>
<p>模块间的函数符号地址与自身的装载地址无关，与其他模块的装载地址相关，因此无法直接通过相对寻址的方式进行调用或跳转。有此引入了GOT结构。ELF会在数据段建一个外部符号的全局偏移表，这个表是一个指向外部符号地址的数组。当代码中需要引用外部符号时，通过访问GOT结构进行间接引用。当模块被装载时，会去装载依赖的其他模块，然后修改GOT中的地址。由此可以发现，代码段的符号重定位变成了数据段的符号重定位。</p>
</li>
<li><p>模块间数据访问</p>
<p>模块间数据的访问处理方式与上述函数调用方式相同，都是通过GOT结构进行间接访问。</p>
</li>
</ul>
<p>综上模块内的符号引用通过相对地址访问、而模块间的符号引用通过GOT间接引用。</p>
<p><strong>二、延迟绑定PLT</strong></p>
<p>​	共享库有利也有弊，在节约空间资源的同时，复杂的GOT重定位会降低程序的启动速度（ps.空间和时间的取舍在计算机中还是会常常面对）。为了解决这一问题，so中引入了PLT结构，将GOT地址的绑定延迟到第一次引用时。plt item结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">foo@plt:</span><br><span class="line">	jump *(foo@got)</span><br><span class="line">	push offset</span><br><span class="line">	jump PLT0</span><br></pre></td></tr></table></figure>

<p>​	foo@got中存放着foo函数的地址，在程序加载时，foo@got的地址为下一条指令的地址，即执行push offset。PLT0为公共的重定位函数——_dl_runtime_resolve。_dl_runtime_resolve函数对入参函数进行重定位，并将重定位的地址写入foo@got。当第二次调用foo函数，将直接调转到foo函数的地址。这样的设计非常巧妙，一个符号的重定位过程只会发生一次，随后的调用无需再进行重定位。</p>
<p><strong>三、动态库结构</strong></p>
<ul>
<li><p>动态符号表：静态链接中，目标文件会有”.symtab“段，段中保存着目标文件的符号的定义和引用。动态库目标文件除了”.symtab“段保存成所有的符号信息外，还有”dynsym”段，保存着动态链接中模块之间的符号关系。</p>
</li>
<li><p>重定位表</p>
</li>
</ul>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p>《程序员的自我修养——链接、装载与库》</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/08/19/LRU%E7%AE%97%E6%B3%95/" rel="prev" title="LRU算法">
                  <i class="fa fa-chevron-left"></i> LRU算法
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/10/07/%E4%BA%86%E8%A7%A3xcodeproj/" rel="next" title="了解xcodeproj">
                  了解xcodeproj <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jin.</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
